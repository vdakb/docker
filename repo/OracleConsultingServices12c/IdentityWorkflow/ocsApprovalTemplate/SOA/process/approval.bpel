<?xml version="1.0" encoding="US-ASCII"?>
<!--
////////////////////////////////////////////////////////////////////////////////
  Oracle JDeveloper BPEL Designer

  Created: __DATEFULL__
  Author:  dieter.steding@oracle.com
  Type:    BPEL 2.0 Process
  Purpose: Asynchronous Approval Process
////////////////////////////////////////////////////////////////////////////////
-->
<process name           ="ApprovalProcess"
         xmlns          ="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:xsd      ="http://www.w3.org/2001/XMLSchema"
         xmlns:xsi      ="http://www.w3.org/2001/XMLSchema-instance"
         xmlns:ui       ="http://xmlns.oracle.com/soa/designer"
         xmlns:wf       ="http://schemas.oracle.com/bpel/extension/workflow"
         xmlns:xdk      ="http://schemas.oracle.com/bpel/extension/xpath/function/xdk"
         xmlns:ora      ="http://schemas.oracle.com/xpath/extension"
         xmlns:hwf      ="http://xmlns.oracle.com/bpel/workflow/xpath"
         xmlns:ids      ="http://xmlns.oracle.com/bpel/services/IdentityService/xpath"
         xmlns:bpm      ="http://xmlns.oracle.com/bpmn20/extensions"
         xmlns:ess      ="http://xmlns.oracle.com/scheduler"
         xmlns:addr     ="http://www.w3.org/2005/08/addressing"
         xmlns:ldap     ="http://schemas.oracle.com/xpath/extension/ldap"
         xmlns:bpws     ="http://schemas.xmlsoap.org/ws/2003/03/business-process/"
         xmlns:bpelx    ="http://schemas.oracle.com/bpel/extension"
         xmlns:bpel2    ="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:task     ="http://xmlns.oracle.com/bpel/workflow/taskService"
         xmlns:dvml     ="http://www.oracle.com/XSL/Transform/java/oracle.tip.dvm.LookupValue"
         xmlns:xslp     ="http://www.oracle.com/XSL/Transform/java/oracle.tip.pc.services.functions.Xpath20"
         xmlns:xslf     ="http://www.oracle.com/XSL/Transform/java/oracle.tip.pc.services.functions.ExtFunc"
         xmlns:xref     ="http://www.oracle.com/XSL/Transform/java/oracle.tip.xref.xpath.XRefXPathFunctions"
         xmlns:decs     ="http://xmlns.oracle.com/approval-rule/approval-decision"
         xmlns:ns1      ="http://xmlns.oracle.com/request/RequestDetails"
         xmlns:ns2      ="http://wls.ws.workflowservice.platform.iam.oracle/"
         xmlns:ns4      ="http://xmlns.oracle.com/RequestServiceApp_jws/RequestDataService/RequestDataService"
         xmlns:ns5      ="http://xmlns.oracle.com/RequestServiceApp/RequestDataService/GeneralData"
         xmlns:ns6      ="http://xmlns.oracle.com/RequestServiceApp/RequestDataService/RequestData"
         xmlns:ns7      ="http://xmlns.oracle.com/RequestServiceApp/RequestDataService/CatalogData"
         xmlns:ns8      ="http://xmlns.oracle.com/bpel/workflow/task"
         xmlns:ns9      ="http://xmlns.oracle.com/bpel/workflow/TaskEvidenceService"
         xmlns:ns10     ="http://xmlns.oracle.com/bpel/workflow/routingSlip"
         xmlns:client   ="urn:ocs:default:catalog:approver"
         targetNamespace="urn:ocs:default:catalog:approver">

  <import importType="http://schemas.xmlsoap.org/wsdl/" ui:processWSDL="true" location="../wsdl/approval-process.wsdl"  namespace="urn:ocs:default:catalog:approver"/>
  <import importType="http://schemas.xmlsoap.org/wsdl/" ui:processWSDL="true" location="../wsdl/request-service.wsdl"   namespace="http://xmlns.oracle.com/RequestServiceApp_jws/RequestDataService/RequestDataService"/>
  <import importType="http://schemas.xmlsoap.org/wsdl/" ui:processWSDL="true" location="../wsdl/callback-service.wsdl"  namespace="http://wls.ws.workflowservice.platform.iam.oracle/"/>

  <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   |   PARTNERLINKS
   |   ~~~~~~~~~~~~
   |   List of services participating in this BPEL process.
   +~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
  <partnerLinks>
    <!--
     | The 'client' role represents the requester of this service. It is used
     | for callback. The location and correlation information associated with
     | the client role are automatically set using WS-Addressing.
     -->
    <partnerLink name="RequestApprovalService"       partnerLinkType="client:ApprovalProcessEndpoint" partnerRole="ApprovalProcessRequester" myRole="ApprovalProcessProvider"/>
    <partnerLink name="CallbackService"              partnerLinkType="ns2:CallbackServiceEndpoint"    partnerRole="CallbackServiceProvider"/>
    <partnerLink name="RequestService"               partnerLinkType="ns4:RequestDataServiceEndpoint" partnerRole="RequestDataServiceProvider"/>
    <partnerLink name="ApprovalRule.DecisionService" partnerLinkType="decs:DecisionServiceEndpoint"   partnerRole="IDecisionService_Role"/>
    <partnerLink name="ApprovalTask.TaskService"     partnerLinkType="task:TaskService"               partnerRole="TaskService" myRole="TaskServiceCallbackListener"/>
    <partnerLink name="ChallengeTask.TaskService"    partnerLinkType="task:TaskService"               partnerRole="TaskService" myRole="TaskServiceCallbackListener"/>
  </partnerLinks>
  <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   |   VARIABLES
   |   ~~~~~~~~~
   |   List of messages and XML documents used within this BPEL process.
   +~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
  <variables>
    <!--
     | Reference to the message passed from Identity Manager as input during initiation
     -->
    <variable name="approvalServiceInput" messageType="client:ApprovalProcessRequestMessage"/>
    <!--
     | Reference to the message that will be sent back to Identity Manager during callback
     -->
    <variable name="approvalServiceOutput" messageType="client:ApprovalProcessResponseMessage"/>
    <!--
     | Reference to the message that will be obtained from Identity Manager
     | during process evaluation
     |
     | Should be taylored to the requirements of the process following the need to know
     | approach
     -->
    <variable name="requestServiceInput"   messageType="ns4:RequestDataServiceRequestMessage"/>
    <variable name="requestServiceOutput"  messageType="ns4:RequestDataServiceResponseMessage"/>
    <variable name="catalogServiceInput"   messageType="ns4:CatalogDataRequestMessage"/>
    <variable name="catalogServiceOutput"  messageType="ns4:CatalogDataResponseMessage"/>
    <variable name="userServiceInput"      messageType="ns4:UserDataServiceRequestMessage"/>
    <variable name="userServiceOutput"     messageType="ns4:UserDataServiceResponseMessage"/>
    <variable name="roleServiceInput"      messageType="ns4:RoleDataServiceRequestMessage"/>
    <variable name="roleServiceOutput"     messageType="ns4:RoleDataServiceResponseMessage"/>
    <!--
     | Reference to the message passed back from Identity Manager during approval
     -->
    <variable name="approvalMessage"       messageType="task:taskMessage"/>
    <!--
     | Reference to the message passed back from Identity Manager during challenge
     -->
    <variable name="challengeMessage"      messageType="task:taskMessage"/>
    <!--
     | Reference to the message that will be sent back to Identity Manager
     | during termination
     -->
    <variable name="callbackServiceInput"  messageType="ns2:callback"/>
    <!--
     | Reference to the message passed passed back from Identity Manager during
     | termination
     -->
    <variable name="callbackServiceOutput" messageType="ns2:callbackResponse"/>
  </variables>
  <faultHandlers>
    <catch bpelx:name="CatchAll" faultName="bpelx:remoteFault">
      <sequence name="errorSequence">
        <assign name="callbackInitialize">
          <copy>
            <from>ora:getConversationId()</from>
            <to>$callbackServiceInput.parameters/arg0</to>
          </copy>
          <copy>
            <from>ora:getFaultAsString()</from>
            <to>$callbackServiceInput.parameters/arg1</to>
          </copy>
        </assign>
        <!--
         | Asynchronous callback to the requester.
         | (Note: the callback location and correlation id is transparently
         | handled using WS-addressing.)
         | http://buster.vm.oracle.com:8005/workflowservice/CallbackService
         -->
        <invoke name="callbackError" partnerLink="CallbackService" portType="ns2:CallbackService" operation="callback" inputVariable="callbackServiceInput" outputVariable="callbackServiceOutput"/>
      </sequence>
    </catch>
  </faultHandlers>
  <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   |   ORCHESTRATION LOGIC
   |   ~~~~~~~~~~~~~~~~~~~
   |   Set of activities coordinating the flow of messages across the services
   |   integrated within this business process.
   +~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
  <sequence name="main">
    <!--
     | Receive input from requestor.
     | (Note: This maps to operation defined in approval-process.wsdl)
     -->
    <receive name="receiveInput" partnerLink="RequestApprovalService" portType="client:ApprovalProcess" operation="process" variable="approvalServiceInput" createInstance="yes"/>
    <!--
     | Approval process.
     -->
    <scope name="Approval">
      <bpelx:annotation>
        <bpelx:pattern patternName="bpelx:workflow"/>
      </bpelx:annotation>
      <variables>
        <variable name="approvalTaskInput" messageType="task:initiateTaskMessage"/>
        <variable name="approvalTaskOutcome" messageType="task:initiateTaskResponseMessage"/>
      </variables>
      <sequence>
        <assign name="setupProcess">
          <copy>
            <from>number(3)</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:priority</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:RequestID</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:identificationKey</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:RequesterDetails/ns1:Login</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:creator</to>
          </copy>
          <copy>
            <from>
              <literal>
                <payload xmlns="http://xmlns.oracle.com/bpel/workflow/task">
                  <RequestID xmlns="http://xmlns.oracle.com/bpel/workflow/task"/>
                  <RequestModel xmlns="http://xmlns.oracle.com/bpel/workflow/task"/>
                  <RequestTarget xmlns="http://xmlns.oracle.com/bpel/workflow/task"/>
                  <url xmlns="http://xmlns.oracle.com/bpel/workflow/task"/>
                  <RequesterDetails xmlns="http://xmlns.oracle.com/request/RequestDetails"/>
                  <BeneficiaryDetails xmlns="http://xmlns.oracle.com/request/RequestDetails"/>
                  <ObjectDetails xmlns="http://xmlns.oracle.com/request/RequestDetails"/>
                  <OtherDetails xmlns="http://xmlns.oracle.com/request/RequestDetails"/>
                  <RequesterDisplayName xmlns="http://xmlns.oracle.com/bpel/workflow/task"/>
                  <BeneficiaryDisplayName xmlns="http://xmlns.oracle.com/bpel/workflow/task"/>
                  <Requester xmlns="http://xmlns.oracle.com/bpel/workflow/task"/>
                </payload>
              </literal>
            </from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:RequestID</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns8:RequestID</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:RequestModel</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns8:RequestModel</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:RequestTarget</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns8:RequestTarget</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:url</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns8:url</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:RequesterDetails</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns1:RequesterDetails</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:RequesterDetails/ns1:Login</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns8:Requester</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:RequesterDetails/ns1:DisplayName</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns8:RequesterDisplayName</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:BeneficiaryDetails</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns1:BeneficiaryDetails</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:BeneficiaryDetails/ns1:DisplayName</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns8:BeneficiaryDisplayName</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:ObjectDetails</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns1:ObjectDetails</to>
          </copy>
          <copy>
            <from>$approvalServiceInput.payload/ns1:OtherDetails</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalTaskInput.payload/ns8:task/ns8:payload/ns1:OtherDetails</to>
          </copy>
        </assign>
        <invoke name="initiateProcess" partnerLink="ApprovalTask.TaskService" portType="task:TaskService" operation="initiateTask" inputVariable="approvalTaskInput" outputVariable="approvalTaskOutcome"/>
        <receive name="receiveProcess" partnerLink="ApprovalTask.TaskService" portType="task:TaskServiceCallback" operation="onTaskCompleted" variable="approvalMessage"/>
      </sequence>
    </scope>
    <if name="outcome">
      <documentation>
        <![CDATA[Outcome is REJECT]]>
      </documentation>
      <bpelx:annotation>
        <bpelx:documentation>
          <![CDATA[Outcome is REJECT]]>
        </bpelx:documentation>
      </bpelx:annotation>
      <condition>($approvalMessage.payload/ns8:systemAttributes/ns8:state = string('COMPLETED') and $approvalMessage.payload/ns8:systemAttributes/ns8:outcome = string('REJECT'))</condition>
      <assign name="rejected">
        <copy>
          <from>ora:getConversationId()</from>
          <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$callbackServiceInput.parameters/arg0</to>
        </copy>
        <copy>
          <from>string('rejected')</from>
          <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$callbackServiceInput.parameters/arg1</to>
        </copy>
        <copy>
          <from>string('rejected')</from>
          <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalServiceOutput.payload/client:result</to>
        </copy>
      </assign>
      <elseif>
        <documentation>
          <![CDATA[Outcome is APPROVE]]>
        </documentation>
        <bpelx:annotation>
          <bpelx:documentation>
            <![CDATA[Outcome is APPROVE]]>
          </bpelx:documentation>
        </bpelx:annotation>
        <condition>($approvalMessage.payload/ns8:systemAttributes/ns8:state = string('COMPLETED') and $approvalMessage.payload/ns8:systemAttributes/ns8:outcome = string('APPROVE'))</condition>
        <assign name="approved">
          <copy>
            <from>ora:getConversationId()</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$callbackServiceInput.parameters/arg0</to>
          </copy>
          <copy>
            <from>string('approved')</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$callbackServiceInput.parameters/arg1</to>
          </copy>
          <copy>
            <from>string('approved')</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalServiceOutput.payload/client:result</to>
          </copy>
        </assign>
      </elseif>
      <else>
        <documentation>
          <![CDATA[Outcome is anything else]]>
        </documentation>
        <bpelx:annotation>
          <bpelx:documentation>
            <![CDATA[Outcome is anything else]]>
          </bpelx:documentation>
        </bpelx:annotation>
        <assign name="anything">
          <copy>
            <from>ora:getConversationId()</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$callbackServiceInput.parameters/arg0</to>
          </copy>
          <copy>
            <from>$approvalMessage.payload/ns8:systemAttributes/ns8:state</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$callbackServiceInput.parameters/arg1</to>
          </copy>
          <copy>
            <from>$approvalMessage.payload/ns8:systemAttributes/ns8:state</from>
            <to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">$approvalServiceOutput.payload/client:result</to>
          </copy>
        </assign>
      </else>
    </if>
    <invoke name="callbackComplete" partnerLink="CallbackService" portType="ns2:CallbackService" operation="callback" inputVariable="callbackServiceInput" outputVariable="callbackServiceOutput"/>
    <!--
     | Asynchronous callback to the Identity Manager request interface.
     | (Note: the callback location and correlation id is transparently
     | handled using WS-addressing.)
     -->
    <invoke name="callbackClient" partnerLink="RequestApprovalService" portType="client:ApprovalProcessCallback" operation="processResponse" inputVariable="approvalServiceOutput"/>
  </sequence>
</process>